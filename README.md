# ITS
## 1. 简介
基于神经网络的车辆违章检测采集系统算法端功能实现，包含视频获取、目标检测、目标追踪、车辆分割、车牌识别、违章检测、视频编码、rtsp推流、http server功能。项目使用C++语言完成整体功能实现，使用CMake完成项目构建。  
项目将各个功能使用单例抽象成了各个service模块，每个service独立完成各自功能，均包含一个数据传入接口和处理线程，数据传入接口使用了统一的数据列表，保证了数据的统一性，便于pipline的构建。特别设立ControlService，在该service中完成pipline各个节点的串联，各个服务在处理完成后将处理后的数据传入此service，再从ControlService中对数据做下一级分发，进而构建起整体程序pipline。  
## 2. 功能模块相关设计
## 2.1 车辆检测
使用**YOLOv3**完成目标检测功能。自主构建道路交通车辆数据集，使用darknet完成车辆检测模型训练，得到YOLOv3权重文件，再将权重文件转为标准的onnx模型，然后再使用TensorRT框架对onnx进行量化，得到TensorRT的trt模型；实际使用中使用TensorRT进行模型部署，借助opencv完成图像前处理，再使用TensorRT进行推理得到推理结果，再对推理结果进行后处理，进而得到准确的车辆检测信息。
## 2.2 目标追踪
拿到2.1中车辆检测结果后，应用**SORT**算法完成车辆追踪。SORT算法，全称为Simple Online and Realtime Tracking算法，是一种用于多目标追踪的算法，其优点是简单、快速，适用于实时场景。但其缺点也很明显，比如对遮挡和目标相互交互处理不够好，容易导致轨迹断裂。SORT算法首先使用卡尔曼滤波器对每个已记录的信息进行预测，得到对应当前帧的预测值，再对预测值和检测算法得到的真实值利用匈牙利算法进行匹配，得到全局最佳匹配，未匹配成功则创建新的滤波器记录其轨迹，一定帧数都没有匹配的轨迹则对其信息进行删除。通过此算法得到车辆id。
## 2.3 违章检测
目前时间原因违章检测只做了对车辆压线的判断。车道线信息通过人工在上位端进行绘制，通过折线表示一条车道线，上位端得到绘制结果后将车道线信息通过http接口已json格式下发给算法端，算法端对车道线信息已json格式写入本地文件进行留存，每次启动首先读取车道线信息。算法通过检测框位置和车道线信息判断是否压线，首先得到检测框下边缘左右两点坐标，两坐标具备两台的y值，根据y值寻找车道线中纵坐标大于此y值和小于此y值的连续两点，进而通过车道线两点得到一个直线方程，直线方程带入y值得到同y值下x值，再对x值做判断，其在下边缘两点内则认为压线，为了具备较高的准确性，该项目还对压线百分比做了计算，大于一定阈值才认为是压线。
## 2.3 车牌检测
使用HyperLPR库完成车牌识别功能。HyperLPR是一个基于深度学习的开源车牌识别库，它能够快速而准确地进行车牌检测和识别，支持多种车牌类型，包括蓝牌、黑牌、单层黄牌等，并且能适应不同的光照和天气条件。使用此开源算法免去了复杂的数据集标注过程，并且此算法已具备了不错的准确度和识别速度，因此使用此算法代替了车辆车牌分割，再进行字符识别的方案。
## 2.4 视频编码推流
将算法端采集的视频数据推送至客户端，视频编码使用了ffmpeg库，推流则使用了RTSP协议将编码后的h264数据推送至前端。FFmpeg是一个开源的多媒体框架，能够对视频、音频和其他多媒体文件和流进行解码、编码、转码、复用、解复用、流、过滤和播放。由于其强大的功能和灵活性，FFmpeg被广泛用于许多软件产品和服务中，是处理多媒体内容的重要工具。RTSP协议是一种网络控制协议，广泛应用于娱乐和通信系统中控制流媒体服务器。RTSP本身提供了一个可扩展的框架来控制流媒体传输，允许用户执行播放、暂停、停止、快进、倒退等操作，并且RTSP可以使用TCP或UDP等不同的底层传输协议，RTSP协议本身也是可扩展的，可以随着技术的发展增加新功能。
